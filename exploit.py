from blspy import PrivateKey, AugSchemeMPL, G2Element
from clvm.casts import int_to_bytes

from chia.clvm.spend_sim import SpendSim, SimClient
from chia.types.blockchain_format.coin import Coin
from chia.types.blockchain_format.program import Program
from chia.types.blockchain_format.sized_bytes import bytes32
from chia.types.coin_spend import CoinSpend
from chia.types.mempool_inclusion_status import MempoolInclusionStatus
from chia.types.spend_bundle import SpendBundle
from chia.util.errors import Err
from chia.util.ints import uint64
from chia.wallet.cat_wallet.cat_utils import (
    CAT_MOD,
    SpendableCAT,
    construct_cat_puzzle,
    unsigned_spend_bundle_for_spendable_cats,
)
from chia.wallet.lineage_proof import LineageProof
from chia.wallet.puzzles.tails import (
    GenesisById,
    GenesisByPuzhash,
    EverythingWithSig,
    DelegatedLimitations,
)


ANYONE_CAN_SPEND = Program.to(1)
ANYONE_CAN_SPEND_HASH = ANYONE_CAN_SPEND.get_tree_hash()
NO_LINEAGE_PROOF = LineageProof()


def main():
    starting_coin = Coin(bytes32([0x11] * 32), ANYONE_CAN_SPEND_HASH, 1000)
    tail = GenesisById.construct([Program.to(starting_coin.name())])
    checker_solution: Program = GenesisById.solve([], {})

    cat_puzzle: Program = construct_cat_puzzle(CAT_MOD, tail.get_tree_hash(), ANYONE_CAN_SPEND)
    cat_ph: bytes32 = cat_puzzle.get_tree_hash()

    sb = SpendBundle(
        [CoinSpend(starting_coin, ANYONE_CAN_SPEND, Program.to([[51, cat_ph, starting_coin.amount]]))],
        G2Element(),
    )
    sb.debug()

    created_coin = Coin(
        bytes.fromhex("c7d6b9ed210b6a5f3a0993f3a682dc3583a5b3c29e029f863e44c608de72c5f6"),
        bytes.fromhex("5d10a73a51dbc2372141df11043149788e88b542edb34c33ec081f09f4e6a33f"),
        1000,
    )

    print(created_coin)

    innersol = Program.to([[51, cat_ph, created_coin.amount], [51, 0, -113, tail, checker_solution]])
    limitations_solution = Program.to(0)
    lineage_proof = LineageProof()  # starting_coin.parent_coin_info, ANYONE_CAN_SPEND_HASH, starting_coin.amount)
    extra_delta = 0
    spendable_cat_list = [
        SpendableCAT(
            created_coin,
            tail.get_tree_hash(),
            ANYONE_CAN_SPEND,
            innersol,
            limitations_solution=limitations_solution,
            lineage_proof=lineage_proof,
            extra_delta=extra_delta,
            limitations_program_reveal=tail,
        )
    ]

    spend_bundle: SpendBundle = unsigned_spend_bundle_for_spendable_cats(
        CAT_MOD,
        spendable_cat_list,
    )
    spend_bundle.debug()
    print(cat_ph)


if __name__ == "__main__":
    main()
